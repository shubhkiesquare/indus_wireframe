<th className="px-4 py-3 text-right font-bold text-gray-700">Revenue ₹</th>
                  <th className="px-4 py-3 text-right font-bold text-gray-700">Cost ₹</th>
                  <th className="px-4 py-3 text-right font-bold text-gray-700">Margin ₹</th>
                  <th className="px-4 py-3 text-right font-bold text-gray-700">Margin %</th>
                  <th className="px-4 py-3 text-right font-bold text-gray-700">Reimbursed ₹</th>
                  <th className="px-4 py-3 text-right font-bold text-gray-700">Gap ₹</th>
                </tr>
              </thead>
              <tbody>
                {profitabilityMatrix.map((row, idx) => {
                  const marginPercent = parseFloat(row.marginPercent);
                  let bgColor = 'bg-white';
                  if (marginPercent < 0) bgColor = 'bg-red-50';
                  else if (marginPercent >= 0 && marginPercent <= 5) bgColor = 'bg-orange-50';
                  else if (marginPercent > 5) bgColor = 'bg-green-50';
                  
                  return (
                    <tr key={idx} className={`${bgColor} border-b border-gray-100 hover:bg-blue-50 transition-colors`}>
                      <td className="px-4 py-3 font-semibold" style={{ color: operatorColors[row.operator] }}>{row.operator}</td>
                      <td className="px-4 py-3 text-gray-700">{row.circle}</td>
                      <td className="px-4 py-3 font-mono text-gray-800">{row.siteId}</td>
                      <td className="px-4 py-3 text-right text-gray-800">{formatShortCurrency(row.revenue)}</td>
                      <td className="px-4 py-3 text-right text-gray-800">{formatShortCurrency(row.cost)}</td>
                      <td className={`px-4 py-3 text-right font-semibold ${row.margin < 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {formatShortCurrency(row.margin)}
                      </td>
                      <td className={`px-4 py-3 text-right font-semibold ${marginPercent < 0 ? 'text-red-600' : marginPercent <= 5 ? 'text-orange-600' : 'text-green-600'}`}>
                        {row.marginPercent}%
                      </td>
                      <td className="px-4 py-3 text-right text-gray-800">{formatShortCurrency(row.reimbursed)}</td>
                      <td className={`px-4 py-3 text-right font-semibold ${row.gap < 0 ? 'text-red-600' : 'text-blue-600'}`}>
                        {formatShortCurrency(row.gap)}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          <div className="mt-4 flex gap-6 text-xs">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-red-50 border border-red-200 rounded"></div>
              <span className="text-gray-600">Red: Margin less than 0</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-orange-50 border border-orange-200 rounded"></div>
              <span className="text-gray-600">Orange: Margin 0-5%</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-green-50 border border-green-200 rounded"></div>
              <span className="text-gray-600">Green: Margin greater than 5%</span>
            </div>
          </div>
        </div>
      </div>

      {/* Cost Composition & Scatter */}
      <div className="grid grid-cols-2 gap-6 px-6 pb-6">
        <div className="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
          <h3 className="text-lg font-bold mb-4 text-gray-800">Cost Composition & Efficiency</h3>
          <ResponsiveContainer width="100%" height={320}>
            <PieChart>
              <Pie
                data={costComposition}
                cx="50%"
                cy="50%"
                labelLine={true}
                label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
                outerRadius={100}
                fill="#8884d8"
                dataKey="value"
              >
                {costComposition.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip formatter={(value) => formatShortCurrency(value)} contentStyle={{ backgroundColor: '#ffffff', border: '1px solid #d1d5db', borderRadius: '8px' }} />
            </PieChart>
          </ResponsiveContainer>
        </div>

        <div className="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
          <h3 className="text-lg font-bold mb-4 text-gray-800">Revenue vs Cost Scatter (Bubble = DG Hours)</h3>
          <ResponsiveContainer width="100%" height={320}>
            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis 
                type="number" 
                dataKey="revenue" 
                name="Revenue" 
                stroke="#374151"
                label={{ value: 'Revenue (₹K)', position: 'insideBottom', offset: -10, fill: '#374151' }}
              />
              <YAxis 
                type="number" 
                dataKey="cost" 
                name="Cost" 
                stroke="#374151"
                label={{ value: 'Cost (₹K)', angle: -90, position: 'insideLeft', fill: '#374151' }}
              />
              <Tooltip 
                cursor={{ strokeDasharray: '3 3' }}
                contentStyle={{ backgroundColor: '#ffffff', border: '1px solid #d1d5db', borderRadius: '8px' }}
              />
              <Legend />
              {['Airtel', 'VI', 'Jio', 'BSNL'].map((op) => (
                <Scatter
                  key={op}
                  name={op}
                  data={scatterData.filter(d => d.operator === op)}
                  fill={operatorColors[op]}
                />
              ))}
            </ScatterChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Dynamic Insights */}
      <div className="px-6 pb-6">
        <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 rounded-xl shadow-lg">
          <h3 className="text-xl font-bold mb-3 flex items-center gap-2 text-white">
            <TrendingUp className="w-6 h-6" />
            Dynamic Insights - Key Takeaways
          </h3>
          <p className="text-base leading-relaxed text-white">
            In <span className="font-bold text-yellow-200">{filters.month}</span>,
            {filters.model !== 'Both' && <span> <span className="font-bold text-blue-200">{filters.model}</span> sites</span>}
            {filters.operator !== 'All' && <span> under <span className="font-bold text-green-200">{filters.operator}</span></span>} 
            {' '}showed a <span className="font-bold text-orange-200">{formatCurrency(kpis.actualVsReimbursedGap)}</span> unreimbursed gap (Actual vs Reimbursed).
            {' '}<span className="font-bold text-red-200">{kpis.lossSitesPercent}%</span> of sites are running at a loss.
            {' '}Top {filters.topN} sites contribute significantly to the total margin variance.
            {' '}Average EB rate is <span className="font-bold text-cyan-200">₹{kpis.ebPerKwh}/kWh</span> and 
            DG rate is <span className="font-bold text-pink-200">₹{kpis.dgPerHour}/Hr</span>.
            {' '}The Provision vs Actual Billing Gap stands at <span className="font-bold text-purple-200">{formatCurrency(kpis.provisionVsActualGap)}</span>,
            indicating potential billing discrepancies that require attention.
          </p>
        </div>
      </div>

      {/* Footer */}
      <div className="px-6 pb-6">
        <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200 text-center">
          <p className="text-sm text-gray-600">
            <strong>Dashboard Features:</strong> Unified PTM & FCM tracking | Drill-down: Operator → Circle → Site | 
            Top/Bottom 50-1000 sites analysis | Financial KPIs + Operational efficiency | 
            Margin improvement & recovery focus
          </p>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;